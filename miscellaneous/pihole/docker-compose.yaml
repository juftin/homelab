####################################
# HOSTED PI-HOLE DNS
####################################

secrets:
    admin_password:
        file: ${DOCKER_DIRECTORY}/secrets/admin_password.secret

services:
    pihole:
        container_name: pihole
        image: pihole/pihole:latest
        environment:
            TZ: ${TZ}
            WEBPASSWORD: /run/secrets/admin_password
            DNS1: 8.8.8.8
            DNS2: 8.8.4.4
            VIRTUAL_HOST: ${PIHOLE_SUBDOMAIN:-pihole}.${DOMAIN_NAME}
        secrets:
            - source: admin_password
              target: /run/secrets/admin_password
        volumes:
            - ${DOCKER_DIRECTORY}/miscellaneous/pihole/config/pihole/:/etc/pihole/
            - ${DOCKER_DIRECTORY}/miscellaneous/pihole/config/dnsmasq.d/:/etc/dnsmasq.d/
        networks:
            traefik:
        platform: ${DOCKER_PLATFORM:-linux/amd64}
        ports:
            - ${PHYSICAL_SERVER_IP}:53:53/tcp
            - ${PHYSICAL_SERVER_IP}:53:53/udp
            - ${PHYSICAL_SERVER_IP}:67:67/udp
        cap_add:
            - NET_ADMIN
        labels:
            traefik.enable: true
            traefik.http.routers.pihole-rtr.rule: Host(`${PIHOLE_SUBDOMAIN:-pihole}.${DOMAIN_NAME}`)
            traefik.http.routers.pihole-rtr.service: pihole-svc
            traefik.http.services.pihole-svc.loadbalancer.server.port: 80
            traefik.http.routers.pihole-rtr.entrypoints: websecure
            traefik.http.routers.pihole-rtr.middlewares: chain-oauth-google@file
