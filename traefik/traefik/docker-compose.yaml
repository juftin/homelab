####################################
# TRAEFIK (REVERSE PROXY)
####################################

services:
    traefik:
        container_name: traefik
        image: library/traefik:v2.11
        ports:
            - published: 80
              target: 80
              protocol: tcp
              mode: host
            - published: 443
              target: 443
              protocol: tcp
              mode: host
        environment:
            CF_API_EMAIL: ${CLOUDFLARE_EMAIL}
            CF_API_KEY: ${CLOUDFLARE_API_KEY}
        volumes:
            - ${TRAEFIK_DIRECTORY}/traefik/rules:/rules
            - ${TRAEFIK_DIRECTORY}/traefik/config/logs:/logs
            - ${TRAEFIK_DIRECTORY}/traefik/config/traefik:/etc/traefik
            - ${TRAEFIK_DIRECTORY}/traefik/config/acme/acme.json:/acme.json
        networks:
            traefik:
            docker:
        security_opt:
            - no-new-privileges:true
        restart: always
        platform: ${DOCKER_PLATFORM:-linux/amd64}
        depends_on:
            - socket-proxy
            - duckdns
            - oauth
        command:
            # GLOBAL SETTINGS
            - --global.checkNewVersion=true
            - --global.sendAnonymousUsage=false
            # API SETTINGS
            - --api=true
            - --api.dashboard=true
            # LOGGING SETTINGS
            - --log=true
            - --log.level=INFO # DEBUG, INFO, WARN, ERROR, FATAL, PANIC
            - --accessLog=true
            - --accessLog.filePath=/logs/access.log
            - --accessLog.bufferingSize=100
            - --accessLog.filters.statusCodes=204-299,400-499,500-599
            # PROVIDERS
            - --providers.docker=true
            - --providers.docker.endpoint=tcp://socket-proxy:2375
            - --providers.docker.exposedByDefault=false
            - --providers.docker.network=homelab_traefik
            - --providers.docker.swarmMode=false
            - --providers.file.directory=/rules
            - --providers.file.watch=true
            # ENTRYPOINTS
            - --entryPoints.http.address=:80
            - --entryPoints.https.address=:443
            - --entryPoints.traefik.address=:8080
            - --entrypoints.http.http.redirections.entrypoint.to=https
            - --entrypoints.http.http.redirections.entrypoint.scheme=https
            - --entrypoints.http.http.redirections.entrypoint.permanent=true
            - --entrypoints.https.forwardedHeaders.trustedIPs=${CLOUDFLARE_IPS},${LOCAL_IPS}
            - --entrypoints.https.http.tls.certresolver=dns-cloudflare
            - --entrypoints.https.http.tls.domains[0].main=${DOMAIN_NAME}
            - --entrypoints.https.http.tls.domains[0].sans=*.${DOMAIN_NAME}
            - --entrypoints.https.http.tls=true
            - --entrypoints.https.http.tls.options=tls-opts@file
            # CERTIFICATE RESOLVERS
            - --certificatesResolvers.dns-cloudflare.acme.email=${CLOUDFLARE_EMAIL}
            - --certificatesResolvers.dns-cloudflare.acme.storage=/acme.json
            - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.provider=cloudflare
            - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.resolvers=1.1.1.1:53,1.0.0.1:53
            - --certificatesResolvers.dns-cloudflare.acme.dnsChallenge.delayBeforeCheck=90
        labels:
            traefik.enable: true
            traefik.http.routers.traefik-rtr.rule: Host(`${TRAEFIK_SUBDOMAIN:-traefik}.${DOMAIN_NAME}`)
            traefik.http.routers.traefik-rtr.entrypoints: https
            traefik.http.routers.traefik-rtr.service: api@internal
            traefik.http.routers.traefik-rtr.middlewares: chain-oauth-google@file
